# 「我的腳本」表格數據對應規則

## 📋 目錄

1. [整體流程](#整體流程)
2. [表格欄位對應](#表格欄位對應)
3. [詳細解析規則](#詳細解析規則)
4. [數據結構範例](#數據結構範例)
5. [表格生成規則](#表格生成規則)
6. [儲存規則](#儲存規則)
7. [代碼位置](#代碼位置)

---

## 🔄 整體流程

```
AI生成腳本內容（純文字）
    ↓
extractScriptData() - 清理HTML標籤
    ↓
parseScriptToJSON() - 解析內容為結構化數據
    ↓
生成 JSON 格式（包含 rows 陣列）
    ↓
saveScriptToLocal() - 儲存到 localStorage
    ↓
generateScriptTable() - 轉換為HTML表格
    ↓
顯示在「我的腳本」頁面
```

### 關鍵函數調用鏈

1. **`extractScriptData(content)`** - 入口函數，清理內容並調用解析函數
2. **`parseScriptToJSON(content)`** - 核心解析函數，提取結構化數據
3. **`generateScriptTable(scriptData)`** - 生成HTML表格

---

## 📊 表格欄位對應

表格包含 **6 個欄位**，對應關係如下：

| 表格欄位 | 數據來源欄位 | 提取規則 |
|---------|------------|---------|
| **時間** | `row.start_sec` 和 `row.end_sec` | 格式：`${start_sec}-${end_sec}s` |
| **段落** | `row.section` | Hook / Value 1 / Value 2 / CTA |
| **鏡頭/畫面** | `row.shot_desc` | 鏡頭描述或畫面感 |
| **台詞 (演員口白)** | `row.dialogue` | 演員口白內容 |
| **字幕文字 (可動畫)** | `row.subtitle` | 字幕或大字卡 |
| **音效與轉場** | `row.sfx` | 音效、轉場、音樂 |

---

## 🔍 詳細解析規則

### 1. 時間欄位提取（`start_sec` / `end_sec`）

#### 匹配規則

- **正則表達式**：`/(\d+)-(\d+)s?/i`
- **匹配格式**：`0-5s`、`5-25s`、`25-30s`、`0-5`、`5-25`

#### 範例

```javascript
// 輸入：AI生成內容包含 "0-5s (Hook)"
const timeMatch = line.match(/(\d+)-(\d+)s?/i);
if (timeMatch) {
  startSec = parseInt(timeMatch[1]);  // 0
  endSec = parseInt(timeMatch[2]);    // 5
}
```

#### 處理邏輯

1. 掃描每一行，尋找時間模式
2. 找到時間標記時，保存上一個段落並開始新段落
3. 確保 `end_sec > start_sec`，否則自動調整

---

### 2. 段落類型提取（`section`）

#### 優先順序規則

**第一優先：關鍵字匹配**

- 包含 `hook`（不區分大小寫）→ `"Hook"`
- 包含 `value` 或 `價值` → `"Value 1"`, `"Value 2"`...（自動計數）
- 包含 `cta` 或 `行動呼籲` → `"CTA"`

**第二優先：時間推測**

- `startSec === 0` → `"Hook"`
- 前幾個 Value → `"Value 1"`, `"Value 2"`, `"Value 3"`
- 最後一個段落 → `"CTA"`

#### 範例

```javascript
// 輸入："0-5s (Hook)"
// 輸出：section = "Hook"

// 輸入："5-25s (Value)"
// 輸出：section = "Value 1"

// 輸入："25-30s"
// 輸出：section = "CTA"（根據時間推測）
```

---

### 3. 台詞欄位提取（`dialogue`）

#### 匹配規則

1. **關鍵字匹配**：包含「台詞」或「口白」
2. **引號格式匹配**：
   - `「內容」`（中文引號）
   - `"內容"`（英文引號）
3. **默認規則**：如果沒有標籤，優先填入第一行未標記內容

#### 範例

```javascript
// 輸入："台詞：「警告！AI時代已全面來襲」"
// 輸出：dialogue = "警告！AI時代已全面來襲"

// 輸入："「這就是你的轉型升級關鍵」"
// 輸出：dialogue = "這就是你的轉型升級關鍵"

// 輸入："這是一個普通的台詞內容"
// 輸出：dialogue = "這是一個普通的台詞內容"（如果 dialogue 為空）
```

#### 處理邏輯

```javascript
if (line.includes('台詞') || line.includes('口白') || 
    line.match(/^「.*」$/) || line.match(/^".*"$/)) {
  currentSegment.dialogue = line
    .replace(/^[台詞口白：:]\s*/, '')
    .replace(/^["「]|["」]$/g, '')
    .trim();
}
```

---

### 4. 鏡頭/畫面欄位提取（`shot_desc`）

#### 匹配規則

1. **關鍵字匹配**：包含「鏡頭」或「畫面」
2. **專業術語匹配**：
   - `CU`（Close-up，特寫）
   - `MS`（Medium Shot，中景）
   - `LS`（Long Shot，全景）

#### 範例

```javascript
// 輸入："鏡頭：快速閃過AI機器人、數據、焦慮的營銷人"
// 輸出：shot_desc = "快速閃過AI機器人、數據、焦慮的營銷人"

// 輸入："畫面：AI智能體界面展示功能"
// 輸出：shot_desc = "AI智能體界面展示功能"

// 輸入："CU: 時鐘特寫，指針快速轉動"
// 輸出：shot_desc = "時鐘特寫，指針快速轉動"
```

#### 處理邏輯

```javascript
if (line.includes('鏡頭') || line.includes('畫面') || 
    line.includes('CU') || line.includes('MS') || line.includes('LS')) {
  currentSegment.shot_desc = line
    .replace(/^[鏡頭畫面：:]\s*/, '')
    .trim();
}
```

---

### 5. 字幕欄位提取（`subtitle`）

#### 匹配規則

- 包含「字幕」或「大字卡」

#### 範例

```javascript
// 輸入："字幕：流量全被AI搶走？"
// 輸出：subtitle = "流量全被AI搶走？"

// 輸入："大字卡：Subscribe Now"
// 輸出：subtitle = "Subscribe Now"
```

#### 處理邏輯

```javascript
if (line.includes('字幕') || line.includes('大字卡')) {
  currentSegment.subtitle = line
    .replace(/^[字幕大字卡：:]\s*/, '')
    .trim();
}
```

---

### 6. 音效與轉場欄位提取（`sfx`）

#### 匹配規則

- 包含「音效」、「轉場」或「音樂」

#### 範例

```javascript
// 輸入："音效：緊張音樂"
// 輸出：sfx = "緊張音樂"

// 輸入："轉場：淡入淡出"
// 輸出：sfx = "淡入淡出"

// 輸入："音樂：背景音樂漸強"
// 輸出：sfx = "背景音樂漸強"
```

#### 處理邏輯

```javascript
if (line.includes('音效') || line.includes('轉場') || line.includes('音樂')) {
  currentSegment.sfx = line
    .replace(/^[音效轉場音樂：:]\s*/, '')
    .trim();
}
```

---

## 📝 數據結構範例

### 解析後的 JSON 結構

```json
{
  "title": "AI時代來襲：流量全被搶走？",
  "rows": [
    {
      "start_sec": 0,
      "end_sec": 5,
      "section": "Hook",
      "shot_desc": "快速閃過AI機器人、數據、焦慮的營銷人",
      "dialogue": "警告！AI時代已全面來襲",
      "subtitle": "流量全被AI搶走？",
      "sfx": "緊張音樂"
    },
    {
      "start_sec": 5,
      "end_sec": 25,
      "section": "Value 1",
      "shot_desc": "AI智能體界面展示功能",
      "dialogue": "這就是你的轉型升級關鍵",
      "subtitle": "",
      "sfx": "轉場音效"
    },
    {
      "start_sec": 25,
      "end_sec": 30,
      "section": "CTA",
      "shot_desc": "AI智能體Logo放大，出現訂閱按鈕動畫",
      "dialogue": "立即訂閱，成為AI營銷贏家！",
      "subtitle": "Subscribe Now",
      "sfx": "激勵音樂"
    }
  ]
}
```

### AI 生成內容範例

```
主題標題：AI時代來襲：流量全被搶走？

0-5s (Hook)
鏡頭：快速閃過AI機器人、數據、焦慮的營銷人
台詞：「警告！AI時代已全面來襲」
字幕：流量全被AI搶走？
音效：緊張音樂

5-25s (Value 1)
畫面：AI智能體界面展示功能
台詞：「這就是你的轉型升級關鍵」
轉場：轉場音效

25-30s (CTA)
鏡頭：AI智能體Logo放大，出現訂閱按鈕動畫
台詞：「立即訂閱，成為AI營銷贏家！」
字幕：Subscribe Now
音效：激勵音樂
```

---

## 🎨 表格生成規則（`generateScriptTable`）

### 新格式（優先）：使用 `rows` 陣列

```javascript
if (scriptData.rows && scriptData.rows.length > 0) {
  scriptData.rows.forEach((row, index) => {
    const timeRange = `${row.start_sec}-${row.end_sec}s`;
    const section = row.section || '-';
    const shotDesc = row.shot_desc || '-';
    const dialogue = row.dialogue || '-';
    const subtitle = row.subtitle || '-';
    const sfx = row.sfx || '-';
    
    // 生成表格行 HTML
  });
}
```

### 舊格式（兼容）：使用 `sections` 陣列

```javascript
if (scriptData.sections && scriptData.sections.length > 0) {
  const timeRanges = ['0-3s', '3-7s', '7-15s', '15-25s', '25-30s'];
  // 使用固定時間範圍
  // 從 sections 中提取內容...
}
```

### 表格 HTML 結構

```html
<table>
  <thead>
    <tr>
      <th>時間</th>
      <th>段落</th>
      <th>鏡頭/畫面</th>
      <th>台詞 (演員口白)</th>
      <th>字幕文字 (可動畫)</th>
      <th>音效與轉場</th>
    </tr>
  </thead>
  <tbody>
    <!-- 動態生成的行 -->
  </tbody>
</table>
```

---

## 💾 儲存規則

### 儲存位置

數據儲存在兩個地方：

1. **本地儲存**：`localStorage.getItem('user_scripts')`
2. **後端資料庫**：`POST /api/scripts/save` → `user_scripts` 表

### 儲存結構

```javascript
{
  id: timestamp,                    // 唯一識別符
  name: "腳本名稱",                 // 顯示名稱
  title: "標題",                    // 腳本標題
  content: "原始AI生成內容",         // 完整原始內容
  script_data: {                    // 結構化數據
    title: "標題",
    rows: [                          // 表格行數據
      {
        start_sec: 0,
        end_sec: 5,
        section: "Hook",
        shot_desc: "...",
        dialogue: "...",
        subtitle: "...",
        sfx: "..."
      }
    ]
  },
  platform: "平台名稱",             // 發布平台
  topic: "主題",                    // 內容主題
  profile: "帳號定位",              // 帳號定位
  created_at: "2025-10-30T05:44:00.000Z"  // ISO時間戳
}
```

### 儲存函數

```javascript
// 本地儲存
function saveScriptToLocal(scriptData) {
  const scripts = getLocalScripts();
  const newScript = {
    id: Date.now(),
    ...scriptData,
    created_at: new Date().toISOString()
  };
  scripts.unshift(newScript);
  localStorage.setItem('user_scripts', JSON.stringify(scripts));
}

// 後端儲存
async function saveScript() {
  const scriptData = extractScriptData(content);
  await fetch('/api/scripts/save', {
    method: 'POST',
    body: JSON.stringify({
      user_id: ipPlanningUser.user_id,
      content: content,
      script_data: scriptData,
      platform: currentPlatform,
      topic: currentTopic,
      profile: currentProfile
    })
  });
}
```

---

## 📍 代碼位置

### 主要函數位置

| 函數名稱 | 檔案位置 | 行數範圍 |
|---------|---------|---------|
| `extractScriptData()` | `index.html` | 14926-14946 |
| `parseScriptToJSON()` | `index.html` | 14948-15083 |
| `generateScriptTable()` | `index.html` | 15374-15477 |
| `saveScriptToLocal()` | `index.html` | 15156-15170 |
| `saveScript()` | `index.html` | 14815-14923 |
| `displayScriptsForUserDB()` | `index.html` | 13056-13105 |
| `cleanText()` | `index.html` | 15086-15091 |

### 相關 API 端點

| API 端點 | 方法 | 功能 |
|---------|------|------|
| `/api/scripts/save` | POST | 儲存腳本到後端 |
| `/api/scripts/my` | GET | 獲取用戶腳本列表 |
| `/api/scripts/{id}/name` | PUT | 更新腳本名稱 |
| `/api/scripts/{id}` | DELETE | 刪除腳本 |

---

## 🔧 處理邏輯細節

### 數據清理

所有提取的文本都會經過清理：

```javascript
function cleanText(text) {
  if (!text) return '';
  // 移除末尾空白和標點符號（保留表情符號）
  return text
    .replace(/\s+$/, '')
    .replace(/[。，、；：！？]$/, '');
}
```

### 時間排序

所有段落會按照 `start_sec` 排序：

```javascript
rows.sort((a, b) => a.start_sec - b.start_sec);
```

### 時間驗證

確保時間範圍有效：

```javascript
// 確保 end_sec > start_sec
if (row.end_sec <= row.start_sec) {
  row.end_sec = row.start_sec + 1;
}
```

---

## ⚠️ 注意事項

### 解析失敗處理

如果解析失敗，會返回錯誤結構：

```javascript
{
  error: "PARSE_FAILED",
  message: "腳本格式解析失敗，請檢查內容格式"
}
```

### 兼容性

系統同時支援兩種格式：

1. **新格式**：`script_data.rows` - 包含完整的時間和欄位信息
2. **舊格式**：`script_data.sections` - 使用固定時間範圍

### 默認值

如果某個欄位無法提取，會使用默認值：

- 時間：`-`（如果無法解析）
- 段落：根據時間推測
- 其他欄位：`-`（如果為空）

---

## 📚 相關文檔

- [後端 API 文檔](../ReelMindbackend-main/README.md)
- [腳本儲存系統說明](../ReelMindbackend-main/README.md#腳本儲存系統)

---

**最後更新**：2025-11-04  
**維護者**：開發團隊

