# 使用統計價值與推薦邀請碼機制報告

## 一、使用統計對用戶的價值

### 1. **即時掌握創作產出狀況**
- **今日/本週/本月總計**：讓用戶快速了解自己的創作頻率和產出量
- **趨勢圖表**：透過視覺化圖表，用戶可以清楚看到自己的使用趨勢，判斷是否保持穩定的創作節奏
- **價值**：幫助用戶建立創作習慣，透過數據激勵持續創作

### 2. **內容類型分析**
- **腳本 vs 生成記錄統計**：了解用戶更偏好使用哪種功能（IP人設規劃 vs 一鍵生成）
- **主題熱度分析**：顯示用戶最常創作的主題類型，幫助用戶發現自己的內容定位
- **價值**：幫助用戶優化創作策略，專注於最有效果的內容類型

### 3. **生產力洞察**
- **產出效率趨勢**：透過折線圖顯示每日/每週/每月的產出變化
- **活躍度分析**：DAU/WAU 數據幫助用戶了解自己的使用頻率
- **價值**：識別創作高峰期和低谷期，優化時間管理

### 4. **AI 智能分析**
- **個人化建議**：系統會使用 LLM 分析用戶的統計數據，提供個人化的創作建議
- **內容策略優化**：基於歷史數據，AI 可以建議用戶調整創作方向
- **價值**：提供專業級的內容策略建議，幫助用戶提升內容品質

### 5. **目標設定與追蹤**
- **數據驅動的目標設定**：用戶可以基於歷史數據設定合理的創作目標
- **進度追蹤**：透過統計數據，用戶可以追蹤自己是否達成目標
- **價值**：建立可量化的目標管理系統，提升用戶的成就感和持續使用意願

### 6. **內容資料庫管理**
- **儲存內容統計**：了解自己累積了多少腳本、對話記錄、生成記錄
- **分類占比分析**：了解不同類型內容的分布情況
- **價值**：幫助用戶管理自己的內容資產，發現內容庫的優勢和不足

---

## 二、推薦邀請碼機制完整報告

### 獎勵機制說明（重要）

**推薦獎勵分為三類**：

1. **註冊獎勵（7 天免費試用延長）**
   - 無限制，每成功邀請一位好友註冊都可以獲得

2. **二選一獎勵（擇一發放，先達到條件者優先）**：
   - **訂閱獎勵（30 天使用期限）**：被推薦用戶完成首次訂閱時發放
   - **里程碑獎勵（1 個月免費使用）**：累積邀請 5 位付費用戶時發放
   - **重要**：兩個獎勵為二選一，先達到條件者優先發放，已發放過的獎勵不會重複發放

### 當前實現狀況

#### 前端實現（已完成）
1. **個人資料頁面 - 推薦邀請標籤頁**
   - 顯示用戶的推薦碼（基於 `user_id` 生成）
   - 顯示推薦連結（`/#/?ref={code}`）
   - 顯示推薦統計（成功邀請數、累積獎勵）
   - 複製推薦碼和推薦連結功能
   - 獎勵機制說明

2. **推薦碼生成邏輯（前端）**
   ```typescript
   const code = user.user_id.substring(0, 8).toUpperCase() + 
                Math.random().toString(36).substring(2, 6).toUpperCase();
   ```
   - 問題：每次載入都會生成新的隨機碼，導致推薦碼不穩定

#### 後端實現（**尚未實現**）
目前後端**沒有**推薦邀請碼相關的：
- 數據庫表結構
- API 端點
- 推薦追蹤邏輯
- 獎勵發放機制
- 通知系統

---

### 需要實現的後端機制

#### 1. 數據庫表結構

##### 1.1 `referral_codes` 表（推薦碼表）
```sql
CREATE TABLE IF NOT EXISTS referral_codes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL UNIQUE,  -- 推薦人 ID
    referral_code TEXT NOT NULL UNIQUE,  -- 推薦碼（固定，不變）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user_profiles (user_id)
);
```

##### 1.2 `referral_records` 表（推薦記錄表）
```sql
CREATE TABLE IF NOT EXISTS referral_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_id TEXT NOT NULL,  -- 推薦人 ID
    referred_id TEXT NOT NULL UNIQUE,  -- 被推薦人 ID（新註冊用戶）
    referral_code TEXT NOT NULL,  -- 使用的推薦碼
    registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 註冊時間
    status TEXT DEFAULT 'pending',  -- pending, completed, rewarded
    reward_type TEXT,  -- 'trial_extension', 'subscription_bonus', 'monthly_free'
    reward_amount INTEGER,  -- 獎勵天數
    rewarded_at TIMESTAMP,  -- 獎勵發放時間
    FOREIGN KEY (referrer_id) REFERENCES user_profiles (user_id),
    FOREIGN KEY (referred_id) REFERENCES user_profiles (user_id)
);
```

##### 1.3 `referral_rewards` 表（推薦獎勵記錄表）
```sql
CREATE TABLE IF NOT EXISTS referral_rewards (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    referrer_id TEXT NOT NULL,  -- 推薦人 ID
    referral_record_id INTEGER NOT NULL,  -- 對應的推薦記錄 ID
    reward_type TEXT NOT NULL,  -- 'trial_extension', 'subscription_bonus', 'monthly_free'
    reward_amount INTEGER NOT NULL,  -- 獎勵天數
    description TEXT,  -- 獎勵說明
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (referrer_id) REFERENCES user_profiles (user_id),
    FOREIGN KEY (referral_record_id) REFERENCES referral_records (id)
);
```

#### 2. API 端點設計

##### 2.1 獲取/生成推薦碼
```
GET /api/user/referral/code
```
- **功能**：獲取用戶的推薦碼（如果不存在則生成）
- **響應**：
  ```json
  {
    "referral_code": "5CB97639KLPD",
    "referral_link": "https://reelmindv2.zeabur.app/#/?ref=5CB97639KLPD"
  }
  ```

##### 2.2 獲取推薦統計
```
GET /api/user/referral/stats/{user_id}
```
- **功能**：獲取用戶的推薦統計數據
- **響應**：
  ```json
  {
    "total_referrals": 3,  // 總邀請數
    "successful_referrals": 2,  // 成功邀請數（已完成註冊）
    "pending_referrals": 1,  // 待確認邀請數
    "rewards": 14,  // 累積獎勵天數
    "trial_extensions": 14,  // 試用延長天數
    "subscription_bonuses": 0,  // 訂閱獎勵天數
    "monthly_free_earned": false  // 是否已獲得1個月免費
  }
  ```

##### 2.3 獲取推薦記錄列表
```
GET /api/user/referral/records
```
- **功能**：獲取用戶的所有推薦記錄
- **響應**：
  ```json
  {
    "records": [
      {
        "referred_user_id": "user123",
        "referred_user_name": "張三",
        "registered_at": "2025-11-29T10:00:00Z",
        "status": "completed",
        "reward_type": "trial_extension",
        "reward_amount": 7
      }
    ]
  }
  ```

##### 2.4 處理推薦註冊（內部 API）
```
POST /api/internal/referral/register
```
- **功能**：當新用戶註冊時，檢查是否有推薦碼並記錄
- **請求體**：
  ```json
  {
    "new_user_id": "user123",
    "referral_code": "5CB97639KLPD"  // 從 URL 參數 ?ref= 獲取
  }
  ```
- **邏輯**：
  1. 驗證推薦碼是否存在
  2. 創建 `referral_records` 記錄（status='pending'）
  3. 發放第一個獎勵：7 天免費試用延長
  4. 更新 `referral_records` status='completed'
  5. 創建 `referral_rewards` 記錄

##### 2.5 處理推薦訂閱（內部 API）
```
POST /api/internal/referral/subscription
```
- **功能**：當被推薦用戶完成首次訂閱時，發放額外獎勵
- **請求體**：
  ```json
  {
    "referred_user_id": "user123",
    "subscription_plan": "monthly"
  }
  ```
- **邏輯**：
  1. 查找對應的 `referral_records`
  2. 發放 30 天使用期限獎勵
  3. 更新 `referral_records` 和創建 `referral_rewards`
  4. 檢查是否達到 5 人門檻，發放 1 個月免費

#### 3. 推薦碼生成邏輯（後端）

```python
def generate_referral_code(user_id: str) -> str:
    """
    生成穩定的推薦碼
    使用 user_id 的 hash + 固定算法，確保每次生成相同
    """
    import hashlib
    
    # 使用 user_id 生成固定 hash
    hash_obj = hashlib.md5(user_id.encode())
    hash_hex = hash_obj.hexdigest()
    
    # 取前 8 位大寫字母數字組合
    code = hash_hex[:8].upper()
    
    # 確保唯一性（如果衝突，添加後綴）
    # 這裡可以加入數據庫檢查邏輯
    
    return code
```

#### 4. 獎勵發放機制

##### 4.1 註冊獎勵（7 天免費試用延長）
- **觸發時機**：新用戶使用推薦碼註冊
- **實現方式**：
  ```python
  # 更新用戶的試用期
  if user.is_trial:
      # 延長試用期 7 天
      new_expire_date = user.trial_expires_at + timedelta(days=7)
      update_user_trial_expires(user_id, new_expire_date)
  ```

##### 4.2 訂閱獎勵（30 天使用期限）與 4.3 里程碑獎勵（1 個月免費）— **二選一機制**

**重要說明**：這兩個獎勵為**二選一**，先達到條件者優先發放，已發放過的獎勵不會重複發放。

**獎勵 A：訂閱獎勵（30 天使用期限）**
- **觸發時機**：被推薦用戶完成首次訂閱
- **限制**：**每個被推薦用戶只能觸發一次**（即使被推薦用戶後續再次訂閱，也不會重複發放）
- **實現方式**：
  ```python
  # 在訂閱 webhook 中檢查
  if is_first_subscription and has_referral_code:
      # 檢查是否已經獲得過里程碑獎勵（1個月免費）
      if not has_received_milestone_reward(referrer_id):
          # 延長訂閱期限 30 天
          new_expire_date = subscription.expires_at + timedelta(days=30)
          update_subscription_expires(user_id, new_expire_date)
          mark_subscription_bonus_received(referrer_id, referred_id)
  ```

**獎勵 B：里程碑獎勵（1 個月免費使用）**
- **觸發時機**：推薦人累積邀請 **5 位付費用戶**（必須完成付費訂閱，月付或年付均可）
- **限制**：
  - **每個推薦人只能獲得一次**（達到 5 位付費用戶後發放，之後即使再邀請更多好友也不會重複發放）
  - **如果推薦人已經獲得過訂閱獎勵（30天），則不再發放此獎勵**（二選一機制）
- **重要**：
  - 只有當被推薦的好友完成**付費訂閱**（月付或年付）時，才會計入里程碑統計
  - 僅完成註冊但未付費的好友**不會**計入 5 人門檻
  - 確保只有真正帶來付費用戶的情況下才發放里程碑獎勵
- **實現方式**：
  ```python
  # 檢查是否已經獲得過訂閱獎勵（30天）- 二選一機制
  if has_received_subscription_bonus(referrer_id):
      logger.info(f"用戶 {referrer_id} 已獲得訂閱獎勵（30天），不再發放里程碑獎勵（二選一機制）")
      return False
  
  # 檢查付費用戶數（只計算完成訂閱的好友）
  paid_referrals_count = count_paid_referrals(referrer_id)
  
  if paid_referrals_count >= 5 and not has_received_milestone_reward(referrer_id):
      # 發放 1 個月免費使用
      extend_subscription_by_days(referrer_id, 30)
      mark_milestone_reward_received(referrer_id)  # 標記已獲得里程碑獎勵
  ```
- **實現方式**：
  ```python
  # 檢查付費用戶數（只計算完成訂閱的好友）
  paid_referrals_count = count_paid_referrals(referrer_id)
  if paid_referrals_count >= 5 and not has_received_monthly_free:
      # 發放 1 個月免費使用
      extend_subscription_by_days(referrer_id, 30)
      mark_monthly_free_received(referrer_id)
  
  def count_paid_referrals(referrer_id: str) -> int:
      """
      計算推薦人有多少位被推薦用戶完成了付費訂閱（月付或年付均可）
      只計算 status='completed' 且 reward_type='subscription_bonus' 的記錄
      """
      # 查詢 referral_records 表
      # WHERE referrer_id = ? AND status = 'completed' AND reward_type = 'subscription_bonus'
      # COUNT(DISTINCT referred_id)
      # 注意：月付和年付都算作付費用戶，只要完成訂閱即可計入
  ```

#### 5. 通知機制

##### 5.1 推薦成功通知
- **觸發時機**：被推薦用戶完成註冊
- **通知方式**：
  - 前端 Toast 通知
  - 可選：Email 通知（如果用戶有設定）
  - 可選：站內通知系統

##### 5.2 獎勵發放通知
- **觸發時機**：獎勵發放時
- **通知內容**：
  ```
  🎉 推薦成功！
  您的好友已成功註冊，您獲得 7 天免費試用延長！
  ```

##### 5.3 里程碑通知
- **觸發時機**：達到 5 人推薦門檻（且未獲得過訂閱獎勵，二選一機制）
- **通知內容**：
  ```
  🎊 恭喜達成里程碑！
  您已成功邀請 5 位付費用戶，獲得 1 個月免費使用！
  （注意：此獎勵與訂閱獎勵為二選一，已發放過的獎勵不會重複發放）
  ```

##### 5.4 訂閱獎勵通知
- **觸發時機**：被推薦用戶完成首次訂閱（且推薦人未獲得過里程碑獎勵，二選一機制）
- **通知內容**：
  ```
  🎉 恭喜！
  您的好友完成首次訂閱，您獲得額外 30 天使用期限！
  （注意：此獎勵與里程碑獎勵為二選一，先達到條件者優先發放）
  ```

#### 6. 推薦碼驗證流程

##### 6.1 註冊流程整合
```python
@app.post("/api/auth/google-new")
async def google_oauth_new(request: Request):
    # ... 現有的 OAuth 邏輯 ...
    
    # 檢查是否有推薦碼
    referral_code = request.cookies.get('referral_code') or request.query_params.get('ref')
    
    if referral_code:
        # 驗證推薦碼
        referrer_id = get_referrer_by_code(referral_code)
        if referrer_id:
            # 記錄推薦關係
            create_referral_record(
                referrer_id=referrer_id,
                referred_id=new_user_id,
                referral_code=referral_code
            )
            # 發放註冊獎勵
            grant_trial_extension(referrer_id, days=7)
    
    # ... 繼續註冊流程 ...
```

##### 6.2 URL 參數處理（前端）
```typescript
// 在登入/註冊頁面
useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const refCode = urlParams.get('ref');
  if (refCode) {
    // 儲存到 localStorage 或 cookie
    localStorage.setItem('referral_code', refCode);
    // 或設置 cookie（後端可讀取）
    document.cookie = `referral_code=${refCode}; path=/; max-age=86400`; // 24小時
  }
}, []);
```

#### 7. 防作弊機制

##### 7.1 防止自我推薦
```python
def validate_referral(referrer_id: str, referred_id: str) -> bool:
    """驗證推薦關係是否有效"""
    if referrer_id == referred_id:
        return False  # 不能推薦自己
    return True
```

##### 7.2 防止重複獎勵
```python
def check_already_rewarded(referrer_id: str, referred_id: str) -> bool:
    """檢查是否已經發放過獎勵"""
    existing = get_referral_record(referrer_id, referred_id)
    return existing and existing.status == 'rewarded'
```

##### 7.3 IP 地址檢查（可選）
```python
def check_suspicious_activity(referrer_id: str, referred_ip: str) -> bool:
    """檢查是否有可疑活動（同一 IP 多次註冊）"""
    # 可以記錄 IP，如果同一 IP 註冊過多，標記為可疑
    pass
```

---

### 實施優先級建議

#### 第一階段（核心功能）
1. ✅ 數據庫表結構創建
2. ✅ 推薦碼生成 API
3. ✅ 推薦統計 API
4. ✅ 註冊時推薦碼處理
5. ✅ 註冊獎勵發放（7 天試用延長）

#### 第二階段（進階功能）
1. ⏳ 訂閱獎勵發放（30 天使用期限）
2. ⏳ 累積獎勵檢查（5 人門檻）
3. ⏳ 推薦記錄列表 API
4. ⏳ 前端通知系統

#### 第三階段（優化功能）
1. ⏳ Email 通知（可選）
2. ⏳ 防作弊機制強化
3. ⏳ 推薦排行榜（可選）
4. ⏳ 推薦活動頁面（可選）

---

### 數據庫遷移腳本示例

```python
def init_referral_tables():
    """初始化推薦相關數據表"""
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # 創建推薦碼表
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS referral_codes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL UNIQUE,
            referral_code TEXT NOT NULL UNIQUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES user_profiles (user_id)
        )
    """)
    
    # 創建推薦記錄表
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS referral_records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            referrer_id TEXT NOT NULL,
            referred_id TEXT NOT NULL UNIQUE,
            referral_code TEXT NOT NULL,
            registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            status TEXT DEFAULT 'pending',
            reward_type TEXT,
            reward_amount INTEGER,
            rewarded_at TIMESTAMP,
            FOREIGN KEY (referrer_id) REFERENCES user_profiles (user_id),
            FOREIGN KEY (referred_id) REFERENCES user_profiles (user_id)
        )
    """)
    
    # 創建推薦獎勵表
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS referral_rewards (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            referrer_id TEXT NOT NULL,
            referral_record_id INTEGER NOT NULL,
            reward_type TEXT NOT NULL,
            reward_amount INTEGER NOT NULL,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (referrer_id) REFERENCES user_profiles (user_id),
            FOREIGN KEY (referral_record_id) REFERENCES referral_records (id)
        )
    """)
    
    conn.commit()
    conn.close()
```

---

### 總結

**當前狀態**：
- ✅ 前端 UI 已完成
- ❌ 後端機制尚未實現
- ❌ 推薦碼生成不穩定（每次載入都變）
- ❌ 沒有推薦追蹤和獎勵發放邏輯

**建議**：
1. 優先實現核心的推薦碼生成和追蹤功能
2. 整合到現有的註冊和訂閱流程中
3. 實現基本的獎勵發放機制
4. 添加通知系統，讓用戶知道獲得獎勵

**預期效果**：
- 提升用戶獲取（User Acquisition）
- 增加用戶留存率（Retention）
- 建立用戶社群（Community）
- 降低獲客成本（CAC）

