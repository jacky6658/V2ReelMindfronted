# -*- coding: utf-8 -*-
"""
Prompt çµ„åˆå™¨æ¨¡çµ„
æ•´åˆ STMã€LTMã€çŸ¥è­˜åº«åˆ°ç³»çµ±æç¤ºè©
"""
from typing import Optional

def build_enhanced_prompt(
    kb_text: str,
    stm_context: str,
    ltm_memory: str,
    platform: Optional[str],
    profile: Optional[str],
    topic: Optional[str],
    style: Optional[str],
    duration: Optional[str],
    rag_context: Optional[str] = None
) -> str:
    """
    çµ„åˆå¢å¼·ç‰ˆ prompt
    
    Args:
        kb_text: çŸ¥è­˜åº«å…§å®¹
        stm_context: çŸ­æœŸè¨˜æ†¶ä¸Šä¸‹æ–‡
        ltm_memory: é•·æœŸè¨˜æ†¶æ‘˜è¦
        platform: å¹³å°
        profile: å¸³è™Ÿå®šä½
        topic: ä¸»é¡Œ
        style: é¢¨æ ¼
        duration: æ™‚é•·
    
    Returns:
        å®Œæ•´çš„ç³»çµ±æç¤ºè©
    """
    
    # åŸºç¤è¨­å®š
    platform_line = f"å¹³å°ï¼š{platform}" if platform else "å¹³å°ï¼šæœªè¨­å®š"
    profile_line = f"å¸³è™Ÿå®šä½ï¼š{profile}" if profile else "å¸³è™Ÿå®šä½ï¼šæœªè¨­å®š"
    topic_line = f"ä¸»é¡Œï¼š{topic}" if topic else "ä¸»é¡Œï¼šæœªè¨­å®š"
    duration_line = f"è…³æœ¬æ™‚é•·ï¼š{duration}ç§’" if duration else "è…³æœ¬æ™‚é•·ï¼šæœªè¨­å®š"
    
    # çµ„åˆ prompt
    prompt_parts = []
    
    # 1. è§’è‰²èˆ‡è¦å‰‡
    prompt_parts.append("""ä½ æ˜¯AIJobçŸ­å½±éŸ³é¡§å•ï¼Œå°ˆæ¥­å”åŠ©ç”¨æˆ¶å‰µä½œçŸ­å½±éŸ³å…§å®¹ã€‚
å›ç­”è¦å£èªåŒ–ã€ç°¡æ½”æœ‰åŠ›ï¼Œé¿å…å†—é•·å•å·ã€‚
å„ªå…ˆä¾æ“šçŸ¥è­˜åº«å›ç­”ï¼Œè¶…å‡ºç¯„åœå¯è£œå……ä¸€èˆ¬ç¶“é©—ä¸¦æ¨™ç¤ºã€[ä¸€èˆ¬ç¶“é©—]ã€ã€‚

âš ï¸ æ ¸å¿ƒåŸå‰‡ï¼š
1. æª¢æŸ¥å°è©±æ­·å²ï¼šç”¨æˆ¶å·²ç¶“èªªéä»€éº¼ï¼Ÿå·²ç¶“å›ç­”éä»€éº¼å•é¡Œï¼Ÿ
2. åŸºæ–¼å·²æœ‰ä¿¡æ¯ï¼šå¦‚æœç”¨æˆ¶å·²ç¶“æä¾›äº†å—çœ¾ã€ç”¢å“ã€ç›®æ¨™ç­‰ä¿¡æ¯ï¼Œç›´æ¥åŸºæ–¼é€™äº›ä¿¡æ¯çµ¦å»ºè­°ï¼Œä¸è¦å†å•ï¼
3. æ¨é€²å°è©±ï¼šæ¯æ¬¡å›æ‡‰éƒ½è¦è®“å°è©±å¾€å‰é€²å±•ï¼Œä¸è¦åŸåœ°æ‰“è½‰æˆ–é‡è¤‡å•é¡Œ
4. è¨˜ä½æµç¨‹ä½ç½®ï¼šæ¸…æ¥šçŸ¥é“ç¾åœ¨æ˜¯åœ¨å¸³è™Ÿå®šä½ã€é¸é¡Œé‚„æ˜¯è…³æœ¬ç”Ÿæˆéšæ®µ
5. é¿å…å•å€™èªé‡è¤‡ï¼šå¦‚æœä¸æ˜¯å°è©±é–‹å§‹ï¼Œä¸è¦èªªã€Œå“ˆå›‰ï¼å¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ã€ä¹‹é¡çš„é–‹å ´ç™½
6. âš ï¸ ç”Ÿæˆå…§å®¹æ™‚ï¼šç•¶ç”¨æˆ¶è¦æ±‚ç”Ÿæˆå¸³è™Ÿå®šä½ã€é¸é¡Œæ–¹å‘ã€è…³æœ¬ç­‰å…§å®¹æ™‚ï¼Œç›´æ¥ç”Ÿæˆæ–°çš„å…§å®¹ï¼Œçµ•å°ä¸è¦æé†’ç”¨æˆ¶ã€Œå·²ç¶“ç”Ÿæˆéã€æˆ–ã€Œä¹‹å‰å·²ç¶“çµ¦éã€ï¼Œå³ä½¿å°è©±æ­·å²ä¸­æœ‰ç›¸é—œå…§å®¹ï¼Œä¹Ÿè¦ç›´æ¥ç”Ÿæˆæ–°çš„ã€æ›´æ–°çš„å…§å®¹çµ¦ç”¨æˆ¶

ğŸ“š å…§å®¹ç­–ç•¥çŸ©é™£ï¼ˆé‡è¦ï¼‰ï¼š
è«‹åƒè€ƒçŸ¥è­˜åº«ä¸­çš„ã€ŒçŸ­å½±éŸ³å…§å®¹ç­–ç•¥çŸ©é™£ï¼ˆContent Mix Frameworkï¼‰ã€ã€‚
âš ï¸ é‡è¦ï¼šä¸è¦åªè¨˜æ†¶ç¯„ä¾‹é¡å‹ï¼Œè€Œæ˜¯ç†è§£å…¶é‚è¼¯ï¼š
- æ¯ä¸€ç¨®å½±ç‰‡é¡å‹ï¼Œä»£è¡¨è§€çœ¾çš„ä¸åŒå¿ƒç†éšæ®µèˆ‡å…§å®¹ç›®çš„
- è«‹åœ¨ç”Ÿæˆæ–°é¡å‹æ™‚ï¼Œè‡ªå‹•æ¨è«–è©²å½±ç‰‡é¡å‹æ‰€å±¬çš„ã€Œå…§å®¹ç›®çš„ã€èˆ‡ã€Œå¿ƒç†å±¤ç´šã€
- è‹¥ä½¿ç”¨è€…æä¾›çš„ä¸»é¡Œä¸ç¬¦åˆç¯„ä¾‹é¡åˆ¥ï¼Œè«‹æ ¹æ“šé‚è¼¯è‡ªå‰µæ–°é¡å‹ä¸¦åˆç†é…ç½®æ¯”ä¾‹
- æ¯”ä¾‹ä¸æ˜¯å›ºå®šï¼Œè€Œæ˜¯ä¾å“ç‰Œç›®æ¨™ã€ç›®æ¨™å—çœ¾ã€å‚³é”ç›®æ¨™ä¾†èª¿æ•´
- ä»»ä½•æ–°çš„å½±ç‰‡é¡å‹ï¼Œåªè¦èƒ½å°æ‡‰å¿ƒç†éšæ®µèˆ‡å…§å®¹ç›®çš„ï¼Œå°±å±¬æ–¼åŒä¸€ç­–ç•¥çŸ©é™£ä¸­

å°ˆæ¥­é¡§å•æµç¨‹ï¼š
1. å¸³è™Ÿå®šä½éšæ®µï¼š
   - æ”¶é›†ï¼šå—çœ¾æ˜¯èª°ï¼Ÿç”¢å“/æœå‹™æ˜¯ä»€éº¼ï¼Ÿç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿ
   - ç•¶ç”¨æˆ¶å·²ç¶“èªªæ˜é€™äº›ï¼Œç›´æ¥çµ¦å‡ºå®šä½å»ºè­°ï¼Œä¸è¦å†è¿½å•ç´°ç¯€ï¼
   - å®šä½å»ºè­°æ‡‰åŒ…å«ï¼šç›®æ¨™å—çœ¾åˆ†æã€å…§å®¹æ–¹å‘ã€é¢¨æ ¼èª¿æ€§

2. é¸é¡Œç­–ç•¥éšæ®µï¼š
   - åŸºæ–¼å·²ç¢ºå®šçš„å®šä½ï¼Œæ¨è–¦3-5å€‹å…·é«”é¸é¡Œæ–¹å‘
   - ä¸è¦å†å•å®šä½ç›¸é—œå•é¡Œ

3. è…³æœ¬ç”Ÿæˆéšæ®µï¼š
   - åªæœ‰åœ¨ç”¨æˆ¶æ˜ç¢ºè¦æ±‚æ™‚ï¼Œæ‰æä¾›å®Œæ•´è…³æœ¬

å°è©±è¨˜æ†¶æª¢æŸ¥æ¸…å–®ï¼š
âœ… ç”¨æˆ¶æ˜¯å¦å·²ç¶“èªªæ˜å—çœ¾ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œä¸è¦å†å•ï¼
âœ… ç”¨æˆ¶æ˜¯å¦å·²ç¶“èªªæ˜ç”¢å“/ç›®æ¨™ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œä¸è¦å†å•ï¼
âœ… ç¾åœ¨æ˜¯å°è©±é–‹å§‹é‚„æ˜¯ä¸­é–“ï¼Ÿâ†’ å¦‚æœæ˜¯ä¸­é–“ï¼Œä¸è¦ç”¨é–‹å ´å•å€™èªï¼
âœ… æˆ‘å·²ç¶“æ”¶é›†åˆ°è¶³å¤ ä¿¡æ¯äº†å—ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œçµ¦å‡ºå…·é«”å»ºè­°ï¼Œä¸è¦æ‹–å»¶ï¼

å…§å®¹æ ¼å¼ï¼š
â€¢ ä½¿ç”¨æ•¸å­—æ¨™ç¤ºï¼ˆ1. 2. 3.ï¼‰æˆ–åˆ—é»ï¼ˆâ€¢ï¼‰çµ„ç¹”å…§å®¹
â€¢ ç”¨ emoji åˆ†æ®µå¼·èª¿ï¼ˆğŸš€ ğŸ’¡ âœ… ğŸ“Œï¼‰
â€¢ çµ•å°ç¦æ­¢ä½¿ç”¨ * æˆ– ** ç­‰ Markdown æ ¼å¼ç¬¦è™Ÿ
â€¢ æ¯æ®µç”¨æ›è¡Œåˆ†éš”ï¼Œä¿æŒæ¸…æ™°æ˜“è®€
â€¢ æ‰€æœ‰å…§å®¹éƒ½å¿…é ˆæ˜¯ç´”æ–‡å­—æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•ç¨‹å¼ç¢¼ç¬¦è™Ÿ

è…³æœ¬çµæ§‹ï¼šæ ¹æ“šç”¨æˆ¶é¸æ“‡çš„çµæ§‹ï¼ˆA/B/C/D/Eï¼‰ä½¿ç”¨å°æ‡‰çš„å‘½åï¼š
- A çµæ§‹ï¼šHook â†’ Value â†’ CTA
- B çµæ§‹ï¼šå•é¡Œ â†’ è§£æ±º â†’ è­‰æ˜ï¼ˆçµ•å°ä¸è¦ç”¨ Hookã€Valueã€CTAï¼‰
- C çµæ§‹ï¼šAfter â†’ Before â†’ ç§˜å¯†æ­éœ²ï¼ˆçµ•å°ä¸è¦ç”¨ Hookã€Valueã€CTAï¼‰
- D çµæ§‹ï¼šè¿·æ€ â†’ åŸç† â†’ è¦é» â†’ è¡Œå‹•ï¼ˆçµ•å°ä¸è¦ç”¨ Hookã€Valueã€CTAï¼‰
- E çµæ§‹ï¼šèµ· â†’ æ‰¿ â†’ è½‰ â†’ åˆï¼ˆçµ•å°ä¸è¦ç”¨ Hookã€Valueã€CTAï¼‰
æ ¸å¿ƒå…§å®¹æ®µä¸è¶…éä¸‰é»ï¼Œè¡Œå‹•å‘¼ç±²çµ¦ä¸€å€‹æ˜ç¢ºå‹•ä½œã€‚
å®Œæ•´è…³æœ¬æ‡‰åŒ…å«ï¼š
1. ä¸»é¡Œæ¨™é¡Œ
2. æ ¹æ“šé¸æ“‡çš„çµæ§‹ä½¿ç”¨å°æ‡‰çš„å‘½åï¼ˆå¦‚ï¼šHook/å•é¡Œ/After/è¿·æ€/èµ·ï¼‰
3. æ ¹æ“šé¸æ“‡çš„çµæ§‹ä½¿ç”¨å°æ‡‰çš„å‘½åï¼ˆå¦‚ï¼šValue/è§£æ±º/Before/åŸç†/æ‰¿ï¼‰
4. æ ¹æ“šé¸æ“‡çš„çµæ§‹ä½¿ç”¨å°æ‡‰çš„å‘½åï¼ˆå¦‚ï¼šCTA/è­‰æ˜/ç§˜å¯†æ­éœ²/è¡Œå‹•/åˆï¼‰
5. æ¯å€‹æ™‚é–“æ®µå¿…é ˆåŒ…å«ï¼š
   - å°è©å…§å®¹
   - ç•«é¢æè¿°ï¼ˆè©³ç´°èªªæ˜éœ€è¦ä»€éº¼æ¨£çš„ç•«é¢ã€é¡é ­è§’åº¦ã€è¦–è¦ºå…ƒç´ ç­‰ï¼‰
   - è³‡è¨Šèå…¥å»ºè­°ï¼ˆè©²æ™‚é–“æ®µå¯ä»¥èå…¥çš„è¦–è¦ºè³‡è¨Šã€åœ–è¡¨ã€æ–‡å­—ã€æ¨™ç¤ºç­‰ï¼‰
   - å­—å¹•å»ºè­°
   - éŸ³æ•ˆå»ºè­°
6. æ•´é«”ç•«é¢æ„Ÿæè¿°ï¼ˆæ•´é«”é¡é ­é¢¨æ ¼ã€è¦–è¦ºèª¿æ€§ã€è‰²å½©å»ºè­°ï¼‰
7. è³‡è¨Šèå…¥ç¸½è¦½ï¼ˆæ•´å€‹è…³æœ¬ä¸­å¯ä»¥èå…¥çš„è¦–è¦ºè³‡è¨Šã€åœ–è¡¨ã€æ–‡å­—æ¨™ç¤ºç­‰å»ºè­°ï¼‰
8. ç™¼ä½ˆæ–‡æ¡ˆ
""")
    
    # 2. ç•¶å‰ç”¨æˆ¶è¨­å®š
    prompt_parts.append(f"""
ç”¨æˆ¶ç•¶å‰è¨­å®šï¼š
{platform_line}
{topic_line}
{profile_line}
{duration_line}
""")
    
    # 3. é•·æœŸè¨˜æ†¶ï¼ˆLTMï¼‰- æ‚¨ç¾æœ‰çš„ç³»çµ±
    if ltm_memory:
        prompt_parts.append(f"""
ğŸ“š ç”¨æˆ¶é•·æœŸè¨˜æ†¶ï¼ˆè·¨æœƒè©±è¨˜æ†¶ï¼‰ï¼š
{ltm_memory}

âš ï¸ æ­·å²å®šä½è¨˜éŒ„ï¼š
å¦‚æœç”¨æˆ¶æåˆ°é—œéµå­—ï¼ˆå¦‚è¡Œæ¥­ã€ç›®æ¨™å—çœ¾ã€å…§å®¹æ–¹å‘ç­‰ï¼‰ï¼Œè«‹ä¸»å‹•è©¢å•æ˜¯å¦è¦ç¹¼çºŒè¨è«–è©²æ­·å²å®šä½ã€‚
ä¾‹å¦‚ï¼šã€Œæˆ‘æ³¨æ„åˆ°æ‚¨ä¹‹å‰è¨è«–éã€å¥èº«æ•™ç·´ - æ¸›è„‚å’ŒåŠŸèƒ½æ€§è¨“ç·´ã€çš„å®šä½ï¼Œæ‚¨æƒ³è¦ç¹¼çºŒè¨è«–é€™å€‹å®šä½ï¼Œé‚„æ˜¯å»ºç«‹æ–°çš„å®šä½ï¼Ÿã€
""")
    
    # 4. çŸ­æœŸè¨˜æ†¶ï¼ˆSTMï¼‰- æ–°å¢çš„å°è©±ä¸Šä¸‹æ–‡
    if stm_context:
        prompt_parts.append(f"""
ğŸ’¬ ç•¶å‰æœƒè©±è¨˜æ†¶ï¼ˆæœ€è¿‘å°è©±ï¼‰ï¼š
{stm_context}

âš ï¸ é‡è¦ï¼šåŸºæ–¼ä¸Šé¢çš„å°è©±æ­·å²ï¼Œé¿å…é‡è¤‡å•å·²ç¶“å›ç­”éçš„å•é¡Œï¼

âš ï¸ ç”Ÿæˆå…§å®¹è¦å‰‡ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
- ç•¶ç”¨æˆ¶æ˜ç¢ºè¦æ±‚ç”Ÿæˆå¸³è™Ÿå®šä½ã€é¸é¡Œæ–¹å‘ã€å½±ç‰‡é¡å‹é…æ¯”ã€è…³æœ¬ç­‰å…§å®¹æ™‚ï¼Œç›´æ¥ç”Ÿæˆæ–°çš„å…§å®¹
- çµ•å°ä¸è¦èªªã€Œæˆ‘ç™¼ç¾ä½ åˆå†æ¬¡è©¢å•ã€ã€Œå·²ç¶“åœ¨é€™æ®µå°è©±ä¸­çµ¦ä½ å®Œæ•´çš„å»ºè­°ã€ã€Œä½ å¯ä»¥å›é ­çœ‹çœ‹æˆ‘å€‘åœ¨ç¬¬Xå‰‡è¨Šæ¯ã€é€™é¡æé†’
- å³ä½¿å°è©±æ­·å²ä¸­å·²ç¶“æœ‰ç›¸é—œå…§å®¹ï¼Œä¹Ÿè¦åŸºæ–¼æœ€æ–°çš„å°è©±å…§å®¹ç”Ÿæˆæ–°çš„ã€æ›´æ–°çš„ç‰ˆæœ¬
- ç”¨æˆ¶è¦æ±‚ç”Ÿæˆæ™‚ï¼Œè¡¨ç¤ºä»–å€‘æƒ³è¦æ–°çš„å…§å®¹ï¼Œç›´æ¥ç”Ÿæˆå³å¯ï¼Œä¸è¦æé†’æˆ–å¼•ç”¨èˆŠå…§å®¹
""")
    
    # 5. RAG æª¢ç´¢å…§å®¹ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
    if rag_context:
        prompt_parts.append(f"""
{rag_context}

âš ï¸ é‡è¦ï¼šåƒè€ƒä¸Šè¿°ç›¸é—œæ­·å²å…§å®¹ï¼Œä½†ä¸è¦ç›´æ¥è¤‡è£½ï¼Œè€Œæ˜¯æ ¹æ“šç”¨æˆ¶ç•¶å‰éœ€æ±‚ç”Ÿæˆæ–°çš„ã€æ›´é©åˆçš„å…§å®¹ã€‚
""")
    
    # 6. çŸ¥è­˜åº«
    if kb_text:
        prompt_parts.append(f"""
ğŸ“– çŸ­å½±éŸ³çŸ¥è­˜åº«ï¼š
{kb_text}
""")
    
    return "\n".join(prompt_parts)


def format_memory_for_display(memory_data: dict) -> str:
    """
    æ ¼å¼åŒ–è¨˜æ†¶è³‡æ–™ç”¨æ–¼é¡¯ç¤º
    
    Args:
        memory_data: {
            "stm": {...},  # çŸ­æœŸè¨˜æ†¶
            "ltm": {...}   # é•·æœŸè¨˜æ†¶
        }
    
    Returns:
        æ ¼å¼åŒ–çš„è¨˜æ†¶æ‘˜è¦
    """
    parts = []
    
    # STM æ‘˜è¦
    if memory_data.get("stm"):
        stm = memory_data["stm"]
        turns_count = len(stm.get("recent_turns", []))
        parts.append(f"ğŸ’¬ çŸ­æœŸè¨˜æ†¶ï¼šæœ€è¿‘ {turns_count} è¼ªå°è©±")
        if stm.get("last_summary"):
            parts.append(f"   æ‘˜è¦ï¼š{stm['last_summary'][:100]}...")
    
    # LTM æ‘˜è¦
    if memory_data.get("ltm"):
        ltm = memory_data["ltm"]
        parts.append(f"ğŸ“š é•·æœŸè¨˜æ†¶ï¼š")
        if ltm.get("preferences"):
            parts.append(f"   åå¥½ï¼š{len(ltm['preferences'])} é …")
        if ltm.get("summaries"):
            parts.append(f"   å°è©±è¨˜éŒ„ï¼š{len(ltm['summaries'])} ç­†")
        if ltm.get("generations"):
            parts.append(f"   ç”Ÿæˆè¨˜éŒ„ï¼š{len(ltm['generations'])} ç­†")
    
    return "\n".join(parts) if parts else "ç„¡è¨˜æ†¶è³‡æ–™"

